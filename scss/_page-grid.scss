// ==========================================================================
// Page Layout + Grid System (+ Optional TOC, Full-bleed, Bands)
// ==========================================================================
//
// OVERVIEW
// --------
// Layer A — Page chrome + safe area: .page-wrapper
// Layer B — Reading layout (+ optional TOC): .doc-shell / .doc-layout / .toc
// Layer C — Content geometry ruler: .page-grid (+ utilities)
// Layer D — Structural utilities: .full-bleed / .band
// ==========================================================================

// --------------------------------------------------------------------------
// SCSS breakpoints (compile-time constants)
// --------------------------------------------------------------------------

$bp-mobile: 48rem; // generic mobile behaviour
$bp-toc-collapse: 64rem; // reading layout: TOC → no TOC
$bp-grid-collapse: 52rem; // content geometry: reduce padding / collapse breakout

// --------------------------------------------------------------------------
// Global defaults (tokens)
// --------------------------------------------------------------------------

:root {
    --page-grid-gutter: clamp(1rem, 4vw, 3rem);

    /* preferred readable measure (keep fixed; shrink only when forced by track) */
    --page-grid-content-max: 90ch;

    /* max width for breakout content */
    --page-grid-wide-max: 90rem;
}

// ==========================================================================
// Layer A — Page chrome + safe area
// ==========================================================================

.page-wrapper {
    padding-block: 1.5rem;
}

.site-masthead {
    // Header-specific styles live elsewhere
}

// ==========================================================================
// Layer B — Reading layout (+ optional TOC)
// ==========================================================================

.doc-shell {
    margin-inline: auto;
    padding-inline: 0; // page-wrapper provides safe padding
    container-type: inline-size; // boundary for container queries
    max-inline-size: var(--page-grid-wide-max);
}

.doc-layout {
    display: grid;
    align-items: start;
    grid-template-columns: minmax(0, 1fr);
}

.doc-layout:has(.toc) {
    --toc-min: 14rem;
    --toc-max: 18rem;
    --toc-gap: var(--page-grid-gutter);
    --toc-shell-extra: calc(var(--toc-max) + var(--toc-gap));

    grid-template-columns:
        minmax(0, 1fr)
        minmax(var(--toc-min), var(--toc-max));
    gap: var(--toc-gap);
}

/* widen shell only when TOC exists */
.doc-shell:has(.doc-layout > .toc) {
    max-inline-size: calc(var(--page-grid-wide-max) + var(--toc-shell-extra));
}

.doc-layout > .page-grid {
    grid-column: 1;
    min-inline-size: 0;
}

.doc-layout > .toc {
    grid-column: 2;
    position: sticky;
    top: var(--page-grid-gutter);
    max-block-size: calc(100dvh - (var(--page-grid-gutter) * 2));
    overflow: auto;
    min-inline-size: 0;
}

/* container-query TOC collapse */
@container (max-width: #{$bp-toc-collapse}) {
    .doc-layout {
        grid-template-columns: minmax(0, 1fr);
    }

    .doc-layout > .toc {
        display: none;
    }

    .doc-shell {
        max-inline-size: var(--page-grid-wide-max);
    }
}

// ==========================================================================
// Layer C — Content geometry ruler (.page-grid)
// ==========================================================================
//

.page-grid,
.content--full {
    display: grid;

    /* horizontal safe area on both sides of the grid
     clamp(min, fluid, max) */
    --gutter: clamp(1rem, 4vw, 3rem);

    /* preferred readable line length
     this is the target width for the content column */
    --content-max: 90ch;

    /* absolute maximum width allowed for wide / breakout content */
    --wide-max: 90rem;

    /* breakout size calculation:
     (wide-max - content-max) gives the total extra width available
     dividing by 2 splits it evenly on the left and right */
    --breakout: calc((var(--wide-max) - var(--content-max)) / 2);

    /* grid geometry:
     the sum of all columns will never exceed the container width */
    grid-template-columns:
    /* outer flexible space:
       - minimum = gutter (safe area)
       - maximum = remaining free space */
        [full-start] minmax(var(--gutter), 1fr)
        /* breakout column:
       - grows up to --breakout
       - shrinks to 0 before content is forced to shrink */
        [breakout-start] minmax(0, var(--breakout))
        /* content column sizing math:
       - calc(100% - gutter * 2) = available inner space
       - min(...) ensures content never exceeds content-max
       - content only shrinks when container < content-max + gutters */
        [content-start] min(
            calc(100% - (var(--gutter) * 2)),
            var(--content-max)
        )
        [content-end]
        /* symmetric breakout column on the right */
        minmax(0, var(--breakout)) [breakout-end]
        /* symmetric outer flexible space */
        minmax(var(--gutter), 1fr) [full-end];
}

/* default: normal children go to content, including inside nested full */
.page-grid > :not(.content--breakout, .content--full),
.content--full > :not(.content--breakout, .content--full) {
    grid-column: content;
    min-inline-size: 0;
}

/* breakout (wide) */
.page-grid > .content--breakout {
    grid-column: breakout;
    min-inline-size: 0;
}

/* full width (becomes a grid so its children can align to the same tracks) */
.page-grid > .content--full {
    grid-column: full;
    min-inline-size: 0;

    display: grid;
    grid-template-columns: inherit;
}

/* allow breakout inside full-width sections */
.content--full > .content--breakout {
    grid-column: breakout;
    min-inline-size: 0;
}

/* figure integration */
figure.content--breakout,
figure.content--full {
    margin: 0;
}

figure.content--breakout > img,
figure.content--full > img {
    grid-column: full;
    display: block;
    inline-size: 100%;
    max-inline-size: 100%;
    block-size: auto;
}

figure.content--breakout > figcaption,
figure.content--full > figcaption {
    grid-column: content;
    margin-block-start: 0.75rem;
}

/* tables */
.table-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.table-wrap > table {
    inline-size: 100%;
    border-collapse: collapse;
}

/* code blocks */
.codeblock {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 1rem;
    border-radius: 0.75rem;
}

/* container-query tweaks for tight containers */
@container (max-width: #{$bp-grid-collapse}) {
    .page-grid {
        /* collapse breakout cleanly + tighten padding */
        --breakout-max-width: var(--content-max-width);
        --padding-inline: clamp(1rem, 3vw, 1.5rem);
    }
}

// ==========================================================================
// Layer D — Structural utilities (full-bleed + bands)
// ==========================================================================

.full-bleed {
    /* if used inside .page-grid, allow it to span */
    grid-column: full;

    /* escape centred/max-width containers */
    inline-size: 100%;
    max-inline-size: none;
    margin-inline: calc(50% - 50vw);

    /* prevent 1–2px rounding scrollbars */
    overflow-x: clip;
}

@supports (width: 100dvw) {
    .full-bleed {
        margin-inline: calc(50% - 50dvw);
    }
}

.full-bleed--mobile {
    margin-inline: calc(var(--page-grid-gutter) * -1);

    @media (width >= #{$bp-mobile}) {
        margin-inline: 0;
    }
}
